# ðŸ“¦ Installation

Let's install **qryn** in a snap. All you need is `Docker` to get started.

?> Using a ClickHouse LTS version is suggested. Use latest at your own risk. 

Configuration is performed using [ENV](env.md) parameters passed to the process or container.

<Tabs>
      <Tab label="Docker">
<a id=docker name=docker></a>

![image](https://user-images.githubusercontent.com/1423657/184507884-624b9598-62e1-413f-854e-8210ecac4e75.png ':size=300x100')

Get started in seconds using **qryn** with Docker - _batteries included!_

Each _qryn_ release is automatically pushed to [ghcr](ghcr.io/metrico/gigapipe:latest)

#### NodeJS runtime
```
ghcr.io/metrico/gigapipe:latest
```

##### Docker Compose

Start qryn using a bundled ClickHouse instance: 

```
  qryn:
    image: ghcr.io/metrico/gigapipe:latest
    ports:
      - "3100:3100"
    environment:
      - CLICKHOUSE_SERVER=clickhouse-server
      - CLICKHOUSE_AUTH=qryn:supersecretpassword
      - CLICKHOUSE_DB=qryn
  clickhouse-server:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-server
    environment:
      - CLICKHOUSE_USER=qryn
      - CLICKHOUSE_PASSWORD=supersecretpassword
    ports:
      - 8123:8123
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', '127.0.0.1:8123/ping']
      interval: 1s
      timeout: 1s
      retries: 30
```

If you prefer using a _remote_ ClickHouse instance rather than a local one:

```
qryn:
    image: ghcr.io/metrico/gigapipe:latest
    ports:
      - "3100:3100"
    environment:
      - CLICKHOUSE_SERVER="my.clickhouse.service"
      - CLICKHOUSE_PORT=9443
      - CLICKHOUSE_PROTO="https"
      - CLICKHOUSE_AUTH="admin:supersecretpassword"
      - CLICKHOUSE_DB=qryn
```

To use `qryn` with a [Clickhouse Cluster](https://clickhouse.com/docs/en/architecture/cluster-deployment), include a `CLUSTER_NAME` ENV variable<br>
with the name of the [ClickHouse cluster](https://clickhouse.com/docs/en/architecture/cluster-deployment) you want to use.

```
      - CLUSTER_NAME="mycluster"
```

<br>

Once all settings are ready, deploy your **qryn** instance:

```
docker compose up -d
```

<br>

!> Refer to the [configuration](env.md) for a list of supported parameters

#### Polyglot Demo

Want to see everything in action? 

Get an instant [qryn polyglot demo](https://github.com/metrico/qryn-oss-demo) w/ sample logs, traces and metrics - _batteries included!_

![image](https://user-images.githubusercontent.com/1423657/183257423-59ac2648-0627-4edc-99b0-eea42abc3ca1.png)


?> That's it - demo logs included! Just access your stack using [qryn-view or Grafana](getting-started)
      </Tab>
      <Tab label="K8s">
<a id=k8s name=k8s></a>

![image](https://github.com/user-attachments/assets/9d041e13-9b2a-4f03-89bb-f9e208525e7e ':size=400')

Get started in seconds using **qryn** with Docker - _batteries included!_

Each _qryn_ release is automatically pushed to [ghcr](ghcr.io/metrico/gigapipe:latest)

### Requirements
- Kubernetes 1.19+
- Helm 3.7+

### Install Chart Repository

```bash
helm repo add qryn-helm https://metrico.github.io/qryn-helm/
helm repo update
```

See [helm repository](https://helm.sh/docs/helm/helm_repo/) for command documentation.

### Install Chart
To deploy [qryn](https://github.com/metrico/qryn) using this Helm chart, use the following command:

```bash
helm repo add qryn-helm https://metrico.github.io/qryn-helm/
helm install [RELEASE_NAME] qryn-helm/qryn-helm --version 0.1.1
```

#### Documentation

See [helm install](https://helm.sh/docs/helm/helm_install/) for further documentation.

For customization, you can provide a `values.yaml` file or use `--set` flags to override specific configurations during installation.

Feel free to modify the configurations based on your requirements and environment.

### Global parameters

| Parameter                | Value         |
|--------------------------|---------------|
| kubernetesClusterDomain  | cluster.local |

## global parameters

| Parameter                              | Value         |
|----------------------------------------|---------------|
| nameOverride                           | ""            |
| fullnameOverride                       | ""            |
| imageCredentials                        | {}            |
| replicas                               | 1             |
| service.type                           | ClusterIP     |
| service.port                           | 3100          |
| podAnnotations                         | {}            |
| podLabels                              | qryn          |
| nodeSelector                           | {}            |
| tolerations                            | []            |
| affinity                               | {}            |
| resources.limits.cpu                   | 200m          |
| resources.limits.memory                | 256Mi         |
| resources.requests.cpu                 | 100m          |
| resources.requests.memory              | 128Mi         |
| autoscaling.enabled                    | true          |
| autoscaling.minReplicas                | 1             |
| autoscaling.maxReplicas                | 5             |
| autoscaling.targetCPUUtilizationPercentage | 80        |
| autoscaling.targetMemoryUtilizationPercentage | 80      |
| securityContext                        | {}            |
| ingress.enabled                        | false         |
| ingress.className                      | ""            |
| ingress.annotations                    | {}            |
| ingress.hosts                          | []            |
| ingress.tls                            | []            |

### qryn container parameters

| Environment Variable             | Default        | Usage                                     |
|---------------------------------|----------------|-------------------------------------------|
| CLICKHOUSE_SERVER               | localhost      | Clickhouse Server address                |
| CLICKHOUSE_PORT                 | 8123           | Clickhouse Server port                   |
| CLICKHOUSE_DB                   | qryn           | Clickhouse Database Name                 |
| CLICKHOUSE_AUTH                 | default:       | Clickhouse Authentication (user:password)|
| CLICKHOUSE_PROTO                | http           | Clickhouse Protocol (http, https)        |
| CLICKHOUSE_TIMEFIELD            | record_datetime| Clickhouse DateTime column for native queries|
| CLUSTER_NAME                    | undefined      | Clickhouse Cluster name                  |
| BULK_MAXAGE                     | 2000           | Max Age for Bulk Inserts                 |
| BULK_MAXSIZE                    | 5000           | Max Size for Bulk Inserts                |
| BULK_MAXCACHE                   | 50000          | Max Labels in Memory Cache               |
| LABELS_DAYS                     | 7              | Max Days before Label rotation           |
| SAMPLES_DAYS                    | 7              | Max Days before Timeseries rotation      |
| HOST                            | 0.0.0.0        | HTTP API IP                               |
| PORT                            | 3100           | HTTP API PORT                             |
| QRYN_LOGIN                      | undefined      | Basic HTTP Username                       |
| QRYN_PASSWORD                   | undefined      | Basic HTTP Password                       |
| READONLY                        | false          | Readonly Mode, no DB Init                 |
| OMIT_CREATE_TABLES              | false          | Omit database provisioning on startup. Dangerous.|
| FASTIFY_BODYLIMIT               | 5242880        | API Maximum payload size in bytes        |
| FASTIFY_REQUESTTIMEOUT          | 0              | API Maximum Request Timeout in ms        |
| FASTIFY_MAXREQUESTS             | 0              | API Maximum Requests per socket           |
| FASTIFY_METRICS                 | false          | API /metrics exporter                     |
| ADVANCED_PROMETHEUS_MAX_SAMPLES | 5000000        | Max samples per a promql request         |
| CORS_ALLOW_ORIGIN               | *              | CORS Allow Origin, default to any         |
| TEMPO_SPAN                      | 24             | Default span for Tempo queries in hours  |
| TEMPO_TAGTRACE                  | false          | Optional tagging of TraceID (expensive)  |
| DEBUG                           | false          | Debug Mode (for backwards compatibility) |
| LOG_LEVEL                       | info           | Log Level                                 |
| HASH                            | xxhash64       | Hash function using for fingerprints. Currently supported short-hash and xxhash64 (xxhash64 function)|
| ALERTMAN_URL                    | false          | Alertmanager API URL, i.e., http://my_alertmanager_url:1234|
| ADVANCED_SAMPLES_ORDERING       | timestamp_ns   | Specify the 'ORDER BY' your samples table should use (for multiple use comma-separated list fingerprint,timestamp_ns)|

## ENV Settings
For more information about qryn environment variables, visit [qryn Environments](https://qryn.metrico.in/#/env).


?> That's it - you're ready to run qryn in Kubernetes! Access your stack using qryn-view or Grafana
      </Tab>
      <Tab label="ECS">
<a id=aws name=aws></a>

![image](https://user-images.githubusercontent.com/1423657/196041303-7ec4b3f8-a948-46f2-90ec-1058ec50f91c.png ':size=200')

Use `AWS Fargate` to deploy and scale `qryn` using a remote ClickHouse instance

#### Create ECS Cluster
```
aws ecs create-cluster \
--cluster-name <YOUR_ECS_CLUSTER>
```

#### Create Log group
```
aws logs create-log-group \
--log-group-name /ecs/<YOUR_APP_NAME>/<YOUR_CONTAINER_NAME>
```

#### Create ECS Task Definiton
Every time a task is modified its version increases. For new tasks the version will be 1.
```
aws ecs register-task-definition \
--cli-input-json "file://./<YOUR_TASK_DEF_NAME>.json"
```

> This json file defines the container specification. You can define secrets such as NC_DB and environment variables here.

Here's the sample Task Definition

```json
{
  "family": "qryn-sample-task-def",
  "networkMode": "awsvpc",
  "containerDefinitions": [{
    "name": "<YOUR_CONTAINER_NAME>",
    "image": "ghcr.io/metrico/gigapipe:latest",
    "essential": true,
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "/ecs/<YOUR_APP_NAME>/<YOUR_CONTAINER_NAME>",
        "awslogs-region": "<YOUR_AWS_REGION>",
        "awslogs-stream-prefix": "ecs"
      }
    },
    "secrets": [{
      "name": "<YOUR_SECRETS_NAME>",
      "valueFrom": "<YOUR_SECRET_ARN>"
    }],
    "environment": [{
      "name": "CLICKHOUSE_SERVER",
      "value": "<YOUR_CLICKHOUSE_SERVER_URL>"
    },{
      "name": "CLICKHOUSE_AUTH",
      "value": "<YOUR_CLICKHOUSE_SERVER_AUTH>"
    },{
      "name": "CLICKHOUSE_DB",
      "value": "qryn"
    }],
    "portMappings": [{
      "containerPort": 3100,
      "hostPort": 3100,
      "protocol": "tcp"
    }]
  }],
  "requiresCompatibilities": [
    "FARGATE"
  ],
  "cpu": "256",
  "memory": "2048",
  "executionRoleArn": "<YOUR_ECS_EXECUTION_ROLE_ARN>",
  "taskRoleArn": "<YOUR_ECS_TASK_ROLE_ARN>"
}
```

#### Create ECS Service
```bash
aws ecs create-service \
--cluster <YOUR_ECS_CLUSTER> \
--service-name  <YOUR_SERVICE_NAME> \
--task-definition <YOUR_TASK_DEF>:<YOUR_TASK_DEF_VERSION> \
--desired-count <DESIRED_COUNT> \
--launch-type "FARGATE" \
--platform-version <VERSION> \
--health-check-grace-period-seconds <GRACE_PERIOD_IN_SECOND> \
--network-configuration "awsvpcConfiguration={subnets=["<YOUR_SUBSETS>"], securityGroups=["<YOUR_SECURITY_GROUPS>"], assignPublicIp=ENABLED}" \
--load-balancer targetGroupArn=<TARGET_GROUP_ARN>,containerName=<CONTAINER_NAME>,containerPort=<YOUR_CONTAINER_PORT>
```

> If your service fails to start, you may check the logs in ECS console or in Cloudwatch. Make sure the security groups have the correct inbound and outbound rules.

?> That's it! You are ready to use **qryn** on Fargate!
      </Tab>
      <Tab label="GCP">
<a id=gcp name=gcp></a>

![image](https://user-images.githubusercontent.com/1423657/196041367-1ea95555-4e6d-45bf-b98e-7a8e5d4ddfaa.png ':size=200')

Use `Google Compute Cloud` to deploy and scale `qryn` using a remote ClickHouse instance


#### Pull qryn Image on Cloud Shell
Since Cloud Run only supports images from Google Container Registry (GCR) or Artifact Registry, we need to pull qryn image, tag it and push it in GCP using Cloud Shell. Here are some sample commands which you can execute in Cloud Shell.
```
# pull latest qryn image
docker pull ghcr.io/metrico/gigapipe:latest
```
```
# tag the image
docker tag qryn:latest gcr.io/<MY_PROJECT_ID>/qryn/qryn:latest
```
```
# push the image to GCR
docker push gcr.io/<MY_PROJECT_ID>/qryn/qryn:latest
Deploy qryn on Cloud Run
gcloud run deploy --image=gcr.io/<MY_PROJECT_ID>/qryn/qryn:latest \
                  --set-env-vars "CLICKHOUSE_SERVER=y<YOUR_CLICKHOUSE_SERVER_URL>" \
                  --set-env-vars "CLICKHOUSE_AUTH=<YOUR_CLICKHOUSE_SERVER_AUTH>" \
                  --region=us-central1 \
                  --allow-unauthenticated \
                  --platform=managed 
```

?> That's it! You are ready to use **qryn** on GCP
      </Tab>
      <Tab label="DigitalOcean">
<a id=digital name=digital></a>

![image](https://user-images.githubusercontent.com/1423657/196041474-98130d07-26fc-493c-bd4c-28b55c347aed.png ':size=200')


Use `Digital Ocean` to deploy and scale `qryn` using a remote ClickHouse instance

## Create App

On Home page, Click on `Create` and select `Apps (Deploy your code)`

![image](https://user-images.githubusercontent.com/1423657/196040670-6a9dfba8-c246-4836-9ba0-35f0fda1bb5d.png ':size=200')

![image](https://user-images.githubusercontent.com/1423657/196040591-13bae4b3-4bf8-406d-b48b-5bebf5617d9d.png ':size=200')

### Choose Source: Docker Hub

Configure Docker Hub as the container source

![image](https://user-images.githubusercontent.com/1423657/196040696-428cf633-61e3-4356-9dea-93a9fded1bf9.png ':size=200')

#### Choose Repository
- `qryn`

#### Choose Tag
- `latest` _(optional)_

#### Choose Port
Configure the HTTP port to `3100`

#### Enviroment Variables
Configure the ENV variables for connectivity, authentication, etc

- `CLICKHOUSE_SERVER` = `<YOUR_CLICKHOUSE_SERVER_URL>`
- `CLICKHOUSE_AUTH` = `<YOUR_CLICKHOUSE_SERVER_AUTH>`

### Review and Launch

Review all your App settings and launch in your preferred region

?> That's it! You are ready to use **qryn** on DigitalOcean
      </Tab>
</Tabs>
